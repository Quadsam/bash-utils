#!/usr/bin/env bash

function readconfig() {
	# Read the config file
	source /etc/dwmrun.conf

	# Define a default logfile if unset in the config
	[[ -z $logfile ]] && logfile="/home/quadsam/.cache/dwmrun.log"

	# If no display manager is defined then throw an error
	if [[ -z $displaymgr ]]; then
		log "ERROR: No display manager defined!"
		return 1
	fi
}

function genxinitrc() {
	for ((i=0; i<${#programs[@]}; i++)); do
		printf '%s\n' "${programs[i]}" >>"$xinitrc"
	done
	printf 'exec %s\n' "$displaymgr" >>"$xinitrc"
}

function cleanup() {
	# Remove the xinitrc we generated earlier
	log "Cleaning up generated files..."
	rm -rf "$xinitrc"

	# Check for programs that did not exit with startx
	for ((i=0; i<${#programs[@]}; i++)); do
		pid=$(pidof "${programs[i]}")
		if [[ $pid ]]; then
			log "WARNING: ${programs[i]}($pid) is still running, manually killing"
			kill "$pid"
		fi
	done
}

function log() {
	local message
	message="$1"
	printf '[ %s ] - %s\n' "$(date +'%x %I:%M:%S')" "$message" | tee -a "$logfile"
}


xinitrc=$(mktemp)

if readconfig; then
	log "Using display manager: '$displaymgr'"
	if [[ ${#programs[@]} -gt 0 ]]; then
		log "Additional programs: ${#programs[@]}"
		for ((i=0; i<${#programs[@]}; i++)); do
			log "Program[$i]: '${programs[$i]}'"
		done
	fi

	if genxinitrc; then
		log "Running startx..."
		startx
		log "startx finished with code '$?'"
		cleanup
	else
		log "FATAL: Unable to write '$xinitrc'"
		exit 1
	fi
else
	log "FATAL: error reading config"
	exit 1
fi
